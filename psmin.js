var hostaddr="http://"+window.location.hostname+":"+window.location.port;var stage=null;var layer=null;var objstage=null;var objlayer=null;var libselector=null;var designgroup={name:"none",type:"Group"};var activeobject=null;var objwh=64;var libw=800;var libh=500;var activebutton="select";var activelibobj=null;var ctrlkey=false;var tgroupindicator=null;var tempgroup=new Array();var changeCallback=null;var defcolour="#aaaacc";var defstroke="#000000";var defstrokewidth=2;var dashdef=[10,5];var usedefaults=true;var objdefaults={};function UniqueId(){var b=Math.floor((1+Math.random())*65536);var a=b.toString(16);return a}function uniqueNameonLayer(f){var e=layer;var a=e.getChildren().toArray();var b=f.getAttr("state");var o=new Array();for(var g=0;g<a.length;g++){var k=a[g];if(k.name()!="Selector"&&k.name()!="groupindicator"){var j=k.getAttr("state");o.push(j.name)}}if(b.name=="none"||b.name==""){var d=b.type.toLowerCase()}else{var d=b.name}var m=o.indexOf(d);if(m==-1){h=d}else{var c=a[m].id();if(c==f.id()){h=d}else{var n=0;var l=true;while(n<1000&&l){var h=d+n.toString();if(o.indexOf(h)==-1){l=false}else{n=n+1}}}}return h}function clearActiveObject(){if(activeobject!=null){if(objSelector!=null){objSelector.deleteOldSelector()}activeobject=null;$("#proptable").empty()}}function makelistobj(b,g,j,c){var l=10;var q=g;var i=null;var o=new Kinetic.Rect({draggable:false,x:j,y:c,width:objwh,height:objwh-l,fillAlpha:1});if(q.type=="Group"){i=newgroupobj(false,false,q)}else{i=newobj(false,q)}o.setAttr("id",b);o.setAttr("state",g);var m=getobjextents(i);var n=m.maxx-m.minx;var k=m.maxy-m.miny;if(n>k){var d=objwh/n}else{var d=(objwh-l)/k}i.scale({x:d,y:d});var e=j+d*i.x();var a=c+d*i.y();i.x(e);i.y(a);var f=(i.getAttr("name")).slice(0,10);var p=new Kinetic.Text({name:"objname",draggable:false,x:j+5,y:c+objwh-l,text:f,fontSize:12,fill:"black"});objlayer.add(o);objlayer.add(i);objlayer.add(p);p.moveToTop();o.moveToTop();objlayer.draw();o.on("mouseover",function(){document.body.style.cursor="pointer";cursorstate="onobj"});o.on("mouseout",function(){document.body.style.cursor="default";cursorstate="free"});o.on("mousedown",function(){libselector.x(j);libselector.y(c);libselector.setAttr("visible",true);objlayer.draw();activelibobj=this})}function clearObjects(){var b=(objlayer.getChildren()).toArray();for(var a=0;a<b.length;a++){var c=b[a];if(c.getAttr("name")!="libselector"){c.destroy()}}libselector.setAttr("visible",false);objlayer.clear({x:0,y:0,width:libw,height:libh})}function loadObjects(c){var d=10;var a=d;var f=d;var e=0;var b=0;$.getJSON(hostaddr+"/getobjects",{filter:c},function(g){$.each(g,function(h,j){var k=(j.id).toFixed();var i=JSON.parse(j.jsonstate);if(((b+1)*(objwh+d))>objstage.getWidth()){e=e+1;b=0;if(((e+1)*(objwh+d)+d)>objstage.height()){objstage.height((e+1)*(objwh+d)+d)}}a=b*(objwh+d)+d;f=e*(objwh+d)+d;makelistobj(k,i,a,f);b=b+1})})}function getobjextents(b){var H=(b.getAttr("rotation"))*Math.PI/180;var Q=b.getAttr("state");switch(Q.type){case"Ring":var I=b.getAttr("outerRadius");var N=b.x()-I;var M=b.y()-I;var d=b.x()+I;var c=b.y()-I;var x=b.x()-I;var u=b.y()+I;var q=b.x()+I;var o=b.y()+I;break;case"Star":var I=b.getAttr("outerRadius");var N=b.x()-I;var M=b.y()-I;var d=b.x()+I;var c=b.y()-I;var x=b.x()-I;var u=b.y()+I;var q=b.x()+I;var o=b.y()+I;break;case"RegularPolygon":var I=b.getAttr("radius");var N=b.x()-I;var M=b.y()-I;var d=b.x()+I;var c=b.y()-I;var x=b.x()-I;var u=b.y()+I;var q=b.x()+I;var o=b.y()+I;break;case"Ellipse":var P=b.height();var F=b.width();var K=Math.sqrt((P*P)/4+(F*F)/4);var L=Math.atan2(P,F);var N=Math.round(b.x()+(K*Math.cos(Math.PI-L-H)));var M=Math.round(b.y()-(K*Math.sin(Math.PI-L-H)));var d=Math.round(b.x()+(K*Math.cos(L-H)));var c=Math.round(b.y()-(K*Math.sin(L-H)));var x=Math.round(b.x()+(K*Math.cos(Math.PI-L+H)));var u=Math.round(b.y()+(K*Math.sin(Math.PI-L+H)));var q=Math.round(b.x()+(K*Math.cos(L+H)));var o=Math.round(b.y()+(K*Math.sin(L+H)));break;case"Line":var D=b.points();var y=D[2];var C=Math.cos(H);var s=Math.sin(H);var N=b.x();var M=b.y();var d=N+Math.round(y*C/2);var c=M+Math.round(y*s/2);var x=N-Math.round(y*s/2);var u=M+Math.round(y*C/2);var q=N+Math.round(y*C);var o=M+Math.round(y*s);break;case"PolyLine":var D=b.points();var j=10000;var z=10000;var E=-10000;var f=-10000;var C=Math.cos(H);var s=Math.sin(H);var m=D[0];var a=D[1];for(var O=1;O<D.length/2;O++){var v=D[2*O];var k=D[2*O+1];var P=k-a;var F=v-m;var y=Math.sqrt(P*P+F*F);var G=Math.atan2(P,F);var A=b.x()+Math.round(y*Math.cos(H+G));var n=b.y()+Math.round(y*Math.sin(H+G));if(j>A){j=A}if(z>n){z=n}if(E<A){E=A}if(f<n){f=n}}var N=j;var M=z;var d=E;var c=z;var x=j;var u=f;var q=E;var o=f;break;case"CurvedArrow":var J=b.getAttr("state");var D=[J.x,J.y,J.midX+J.x,J.midY+J.y,J.endX+J.x,J.endY+J.y];var j=10000;var z=10000;var E=-10000;var f=-10000;for(var O=0;O<D.length/2;O++){var v=D[2*O];var k=D[2*O+1];if(j>v){j=v}if(z>k){z=k}if(E<v){E=v}if(f<k){f=k}}var P=f-z;var F=E-j;var C=Math.cos(H);var s=Math.sin(H);var N=b.x();var M=b.y();var d=b.x()+Math.round(F*C);var c=b.y()+Math.round(F*s);var x=b.x()-Math.round(P*s);var u=b.y()+Math.round(P*C);var q=x+Math.round(F*C);var o=u+Math.round(F*s);break;case"Figure":var D=b.points();var j=10000;var z=10000;var E=-10000;var f=-10000;for(var O=0;O<D.length/2;O++){var v=D[2*O];var k=D[2*O+1];if(j>v){j=v}if(z>k){z=k}if(E<v){E=v}if(f<k){f=k}}var P=f-z;var F=E-j;var C=Math.cos(H);var s=Math.sin(H);var N=b.x()-Math.round((F/2)*C);var M=b.y()-Math.round((F/2)*s);var d=b.x()+Math.round((F/2)*C);var c=b.y()+Math.round((F/2)*s);var x=b.x()-Math.round(P*s)-Math.round((F/2)*C);var u=b.y()+Math.round(P*C)-Math.round((F/2)*s);var q=b.x()-Math.round(P*s)+Math.round((F/2)*C);var o=b.y()+Math.round(P*C)+Math.round((F/2)*s);break;default:var P=b.height();var F=b.width();var C=Math.cos(H);var s=Math.sin(H);var N=b.x();var M=b.y();var d=b.x()+Math.round(F*C);var c=b.y()+Math.round(F*s);var x=b.x()-Math.round(P*s);var u=b.y()+Math.round(P*C);var q=x+Math.round(F*C);var o=u+Math.round(F*s);break}var g=Math.min(N,d,x,q);var l=Math.max(N,d,x,q);var t=Math.min(M,c,u,o);var B=Math.max(M,c,u,o);var e={minx:g,maxx:l,miny:t,maxy:B};return e}function checknumObjects(){var c=layer.getChildren();var b=c.length;var a=layer.find(".Selector")[0];if(a!=null){b=b-1}return b}function updateGroupState(m,a){if(m!=null){var b=m.getAttr("state");var f=m.getChildren().toArray();for(var o in a){var s=a[o];var l=false;for(var n=0;n<f.length;n++){var d=f[n].getAttr("state").type;if(d=="RegularPolygon"||d=="Star"||d=="Ring"||d=="Figure"){l=true}}b[o]=s;if(o!="type"){for(var n=0;n<f.length;n++){var e=f[n];var p=e.getAttr("state");if(o=="width"){var h=s/m.width();p.x=h*p.x;e.x(h*e.x());if(l){p.y=h*p.y;e.y(h*e.y())}switch(p.type){case"Group":updateGroupState(e,{x:e.x(),y:e.y(),width:h*e.width()});break;case"RegularPolygon":e.radius(h*e.radius());p.radius=e.radius();break;case"Star":e.outerRadius(h*e.outerRadius());e.innerRadius(h*e.innerRadius());p.outerRadius=e.outerRadius();p.innerRadius=e.innerRadius();break;case"Ring":e.outerRadius(h*e.outerRadius());e.innerRadius(h*e.innerRadius());p.outerRadius=e.outerRadius();p.innerRadius=e.innerRadius();break;case"Line":var q=e.points();var c=p.lineLength*Math.cos(Math.PI*p.rotation/180);var g=p.lineLength*Math.sin(Math.PI*p.rotation/180);if(l){g=g*h}p.lineLength=Math.sqrt(g*g+h*h*c*c);p.rotation=180*Math.atan2(g,c*h)/Math.PI;q[2]=Math.round(p.lineLength);e.rotation(p.rotation);e.points(q);break;case"Figure":var q=e.points();p.scaleSize=p.scaleSize*h;for(var j=0;j<q.length;j++){q[j]=q[j]*h}p.points=q;e.points(q);break;default:e.width(h*e.width());p.width=e.width();if(l){e.height(h*e.height());p.height=e.height()}break}}else{if(o=="height"){var r=s/m.height();p.y=r*p.y;e.y(r*e.y());if(l){p.x=r*p.x;e.x(r*e.x())}switch(p.type){case"Group":updateGroupState(e,{x:e.x(),y:e.y(),height:r*e.height()});break;case"RegularPolygon":e.radius(r*e.radius());p.radius=e.radius();break;case"Star":e.outerRadius(r*e.outerRadius());e.innerRadius(r*e.innerRadius());p.outerRadius=e.outerRadius();p.innerRadius=e.innerRadius();break;case"Ring":e.outerRadius(r*e.outerRadius());e.innerRadius(r*e.innerRadius());p.outerRadius=e.outerRadius();p.innerRadius=e.innerRadius();break;case"Line":var q=e.points();var c=p.lineLength*Math.cos(Math.PI*p.rotation/180);var g=p.lineLength*Math.sin(Math.PI*p.rotation/180);if(l){c=c*r}p.lineLength=Math.sqrt(r*r*g*g+c*c);p.rotation=180*Math.atan2(r*g,c)/Math.PI;q[2]=Math.round(p.lineLength);e.rotation(p.rotation);e.points(q);break;case"Figure":var q=e.points();p.scaleSize=p.scaleSize*r;for(var j=0;j<q.length;j++){q[j]=q[j]*r}e.points(q);p.points=q;break;default:e.height(r*e.height());p.height=e.height();if(l){e.width(r*e.width());p.width=e.width()}break}}}e.setAttr("state",p)}if(o=="width"&&l){var h=s/m.width();m.height(h*m.height());b.height=m.height()}if(o=="height"&&l){var r=s/m.height();m.width(r*m.width());b.width=m.width()}m.setAttr(o,s);m.setAttr("state",b)}}if(b.type!="Stage"&&b.type!="Layer"&&objSelector!=null){objSelector.deleteOldSelector();objSelector.drawSelector(m)}}}function updateState(e,b){if(e!=null){var c=e.getAttr("state");for(var j in b){var n=b[j];if(c.type=="Line"){if(j=="strokeWidth"){if(n<2){n=2}}if(j=="lineLength"){var m=e.points();m[2]=Math.round(n);e.points(m)}}if(j!="type"){if(j=="scaleSize"){var g=new Array();for(var f=0;f<c.points.length;f++){g.push(Math.round(c.points[f]*n))}e.points(g)}else{if(j=="vertices"){var m=c.points;var l=m.length/2;var d=l;while(d<n){m.push(m[d-2]+10*Math.random());m.push(m[d-2]+10*Math.random());d++}while(d>n){m.pop();m.pop();d--}c.points=m;var g=new Array();for(var f=0;f<c.points.length;f++){g.push(Math.round(c.points[f]*c.scaleSize))}e.points(g)}else{if(j=="width"&&c.lockaspect!=null){if(c.lockaspect==true){var a=c.width/c.height;var k=Math.round(n/a);c.height=k;e.height(k)}e.setAttr(j,n)}else{if(j=="height"&&c.lockaspect!=null){if(c.lockaspect==true){var a=c.width/c.height;var h=Math.round(n*a);c.width=h;e.width(h)}e.setAttr(j,n)}else{e.setAttr(j,n)}}}}}c[j]=n}e.setAttr("state",c);if(c.type!="Stage"&&c.type!="Layer"&&objSelector!=null){objSelector.deleteOldSelector();objSelector.drawSelector(e)}if(usedefaults==true){objdefaults[c.type]=JSON.stringify(e.getAttr("state"))}}else{for(var j in b){var n=b[j];console.log(j,n);designgroup[j]=n}}}function clearTempGroup(){if(tgroupindicator!=null){tgroupindicator.destroy();tgroupindicator=null;while(tempgroup.length>0){tempgroup.pop()}layer.draw()}}function addtoTempGroup(c,f){if(f.name()!="Selector"){if(tgroupindicator==null){tgroupindicator=new Kinetic.Rect({name:"groupindicator",fill:"rgb(200,250,200)",stroke:"rgb(0,250,250)",opacity:0.5,strokeWidth:4,dashEnabled:true,dash:[10,5]});var g=10000;var d=1;var e=10000;var b=1;layer.add(tgroupindicator);tgroupindicator.moveToBottom()}else{var g=tgroupindicator.x();var d=g+tgroupindicator.width();var e=tgroupindicator.y();var b=e+tgroupindicator.height()}var a=getobjextents(f);if(a.maxx>d){d=a.maxx}if(a.maxy>b){b=a.maxy}if(a.minx<g){g=a.minx}if(a.miny<e){e=a.miny}tempgroup.push(f);tgroupindicator.x(g);tgroupindicator.y(e);tgroupindicator.width(d-g);tgroupindicator.height(b-e);layer.draw()}}function groupobjects(){var a=100000;var g=1;var o=100000;var c=1;var k=tempgroup.length;clearActiveObject();if(k>1){var b=new Array();for(var e=0;e<k;e++){var d=tempgroup[e];var m=getobjextents(d);if(m.maxx>g){g=m.maxx}if(m.maxy>c){c=m.maxy}if(m.minx<a){a=m.minx}if(m.miny<o){o=m.miny}}var n=g-a;var f=c-o;var l={name:"none",type:"Group",id:"none",x:a,y:o,width:n,height:f,visible:true,opacity:1,children:[]};var j=newgroupobj(true,false,l);while(tempgroup.length>0){var d=tempgroup.pop();d.draggable(false);d.x(d.x()-a);d.y(d.y()-o);var p=d.getAttr("state");p.x=p.x-a;p.y=p.y-o;d.setAttr("state",p);b.push(p);d.off("mousedown");d.off("dragmove");d.off("dragend");d.off("mouseover");d.off("mouseout");j.add(d)}l.children=b;j.setAttr("state",l);layer.add(j);clearTempGroup();return j}else{return null}}function ungroupobjects(){var e=new Array();if(activeobject!=null){layer=activeobject.getLayer();var b=activeobject.getAttr("state");if(b.type=="Group"){var h=(activeobject.getChildren()).toArray();var f=activeobject.x();var j=activeobject.y();var c=activeobject.rotation();for(var g=0;g<h.length;g++){var d=h[g];var l=d.getAttr("state");var a=Math.atan2(l.y,l.x);var k=Math.sqrt(l.x*l.x+l.y*l.y);l.x=f+Math.round(k*Math.cos(a+Math.PI*c/180));l.y=j+Math.round(k*Math.sin(a+Math.PI*c/180));if(l.rotation!=null){l.rotation=l.rotation+c}else{l.rotation=c}d.draggable(true);objEvents(d);d.moveTo(layer);d.x(l.x);d.y(l.y);d.rotation(l.rotation);e.push(d)}if(objSelector!=null){objSelector.deleteOldSelector()}activeobject.destroy();layer.draw();$("#proptable").empty()}}return e}function objEvents(a){a.on("mouseover",function(){document.body.style.cursor="pointer";cursorstate="onobj"});a.on("mouseout",function(){document.body.style.cursor="default";cursorstate="free"});a.on("mousedown",function(){clearActiveObject();if(ctrlkey==true){if(tempgroup.indexOf(this)==-1){$("#proptable").empty();addtoTempGroup(true,this);selectObject("grouping")}}else{if(tgroupindicator!=null){clearTempGroup()}activeobject=a;updatePropDisp();if(objSelector==null){objSelector=new objectSelector()}objSelector.drawSelector(this);selectObject("kineticjs")}});a.on("dragmove",function(){objSelector.drawSelector(this)});a.on("dragend",function(){activeobject=a;updateState(activeobject,{x:this.x(),y:this.y()});updatePropDisp()})}function cleardesign(){var a=checknumObjects();if(a>0){var b=confirm("Are you sure you want to delete the design?");if(b==true){layer.destroyChildren();objSelector=new objectSelector();layer.add(objSelector.objSelGroup);layer.draw();activeobject=null;$("#proptable").empty()}}}function delobj(){objSelector.deleteOldSelector();activeobject.destroy();layer.draw();$("#proptable").empty()}function copyobj(){if(activeobject!=null){var c=JSON.stringify(activeobject.getAttr("state"));var a=JSON.parse(c);a.name="none";a.id="none";a.x=a.x+10;a.y=a.y+10;var b=newobj(true,a);layer.add(b);objSelector.deleteOldSelector();activeobject=b;updatePropDisp();objSelector.drawSelector(b);return b}}function moveup(){if(activeobject!=null){activeobject.moveUp();layer.draw()}}function movedown(){if(activeobject!=null){activeobject.moveDown();layer.draw()}}function newgroupobj(g,b,a){if(a.id=="none"){a.id=UniqueId()}var c=new Kinetic.Group({name:a.name,id:a.id,x:a.x,y:a.y,width:a.width,height:a.height,draggable:g});var h=a.children;for(var e=0;e<h.length;e++){childstate=h[e];if(childstate.type=="Group"){var d=newgroupobj(b,b,childstate)}else{var d=newobj(b,childstate)}c.add(d)}for(var f in a){var j=a[f];c.setAttr(f,j)}if(g){objEvents(c)}c.setAttr("state",a);return c}function newobj(b,d){var a=d.type;if(d.id=="none"){d.id=UniqueId()}switch(a){case"Image":var f=new Image();var e=new Kinetic.Image({id:d.id,image:f,draggable:b});f.onload=function(){var h=e.getLayer();if(h!=null){h.draw()}};f.src=d.path;break;case"Rect":var e=new Kinetic.Rect({id:d.id,draggable:b});break;case"Ellipse":var e=new Kinetic.Ellipse({id:d.id,draggable:b});break;case"RegularPolygon":var e=new Kinetic.RegularPolygon({id:d.id,draggable:b});break;case"Star":var e=new Kinetic.Star({id:d.id,draggable:b});break;case"Ring":var e=new Kinetic.Ring({id:d.id,draggable:b});break;case"Text":var e=new Kinetic.Text({id:d.id,draggable:b});break;case"Line":var e=new Kinetic.Line({id:d.id,points:[0,0,d.lineLength,0],draggable:b});break;case"PolyLine":var e=new Kinetic.Line({id:d.id,draggable:b});break;case"CurvedArrow":var e=CurvedArrow(b,d);break;case"Figure":var e=new Kinetic.Line({id:d.id,closed:true,draggable:b});break;case"Path":var e=new Kinetic.Path({id:d.id,draggable:b});break}if(d.dashEnabled==null){d.dashEnabled=false}e.dash(dashdef);for(var g in d){var c=d[g];e.setAttr(g,c)}if(b){objEvents(e)}e.setAttr("state",d);return e}function addobj(a){var b=Math.round(100*Math.random());var d=Math.round(100*Math.random());var c=null;switch(a){case"Image":activebutton="image";c=newobj(true,{name:"none",id:"none",type:"Image",path:"/images/image.png",x:b,y:d,width:100,height:100,lockaspect:false,rotation:0,visible:true,opacity:1});break;case"Rect":activebutton="rect";c=newobj(true,{name:"none",id:"none",type:"Rect",x:b,y:d,width:50,height:100,lockaspect:false,rotation:0,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,cornerRadius:0,visible:true,opacity:1});break;case"Ellipse":activebutton="ellipse";c=newobj(true,{name:"none",id:"none",type:"Ellipse",x:b+30,y:d+30,width:50,height:80,lockaspect:false,rotation:0,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1});break;case"RegularPolygon":activebutton="polygon";c=newobj(true,{name:"none",id:"none",type:"RegularPolygon",x:b+30,y:d+30,rotation:0,sides:5,radius:30,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1});break;case"Star":activebutton="star";c=newobj(true,{name:"none",id:"none",type:"Star",x:b+30,y:d+30,rotation:0,numPoints:5,innerRadius:15,outerRadius:30,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1});break;case"Ring":activebutton="ring";c=newobj(true,{name:"none",id:"none",type:"Ring",x:b+30,y:d+30,innerRadius:15,outerRadius:30,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1});break;case"Text":activebutton="text";c=newobj(true,{name:"none",id:"none",type:"Text",x:b+30,y:d+30,rotation:0,text:"text",fontSize:24,fontFamily:"Arial",fill:defcolour,stroke:defstroke,strokeWidth:1,dashEnabled:false,visible:true,opacity:1});break;case"Line":activebutton="line";c=newobj(true,{name:"none",id:"none",type:"Line",x:b+30,y:d+30,lineLength:100,rotation:0,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1});break;case"PolyLine":activebutton="polyline";c=newobj(true,{name:"none",id:"none",type:"PolyLine",x:b+30,y:d+30,fill:defcolour,rotation:0,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,vertices:3,tension:0,points:[0,0,-30,100,100,100],closed:true,scaleSize:1,visible:true,opacity:1});break;case"CurvedArrow":activebutton="curvedarrow";c=newobj(true,{name:"none",id:"none",type:"CurvedArrow",x:b+30,y:d+30,rotation:0,fill:defcolour,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,visible:true,opacity:1,portion:1,midX:100,midY:50,endX:100,endY:100,arrowWidth:ar_width,arrowheadLength:ar_headlength,arrowheadWidth:ar_headwidth});break;case"Mfigure":activebutton="mfig";c=newobj(true,{name:"none",id:"none",type:"Figure",x:b+30,y:d+30,fill:defcolour,rotation:0,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,tension:0,points:[0,0,-3.5,1,-7,5,-9,10,-7,16,-2,19,-3,22,-9,22,-22,54,-21,55,-20,57,-16,57,-10,40,-10,90,-8,92,-5,93,-3,90,-2,60,2,60,3,90,5,93,8,92,10,90,10,40,16,57,20,57,21,55,22,54,9,22,3,22,2,19,7,16,9,10,7,5,3.5,1],scaleSize:1,visible:true,opacity:1});break;case"Ffigure":activebutton="ffig";c=newobj(true,{name:"none",id:"none",type:"Figure",x:b+30,y:d+30,fill:defcolour,rotation:0,stroke:defstroke,strokeWidth:defstrokewidth,dashEnabled:false,tension:0,points:[0,0,-3.5,1,-7.5,5,-9,10,-6.7,16,-2,19,-3,22,-9,22,-23,54,-21,55,-19,57,-16,56,-10,40,-15,70,-10,70,-10,90,-8,93,-4.5,93,-3,90,-3,70,3,70,3,90,4.5,93,8,93,10,90,10,70,15,70,10,40,16,56,19,57,21,55,23,54,9,22,3,22,2,19,6.7,16,9,10,7.5,5,3.5,1,0,0],scaleSize:1,visible:true,opacity:1});break}layer.add(c);if(objSelector!=null){objSelector.deleteOldSelector();objSelector.drawSelector(c)}activeobject=c;updatePropDisp();return c}function coreSetup(){$(document).keydown(function(b){var a=(b.keyCode?b.keyCode:b.which)});$(document).keyup(function(b){var a=(b.keyCode?b.keyCode:b.which)});libselector=new Kinetic.Rect({name:"libselector",visible:false,width:objwh,height:objwh,fill:"#ccccee",stroke:"#ccccee",strokeWidth:1})}USEIO=true;var socket;var serverurl="http://"+window.location.hostname+":"+window.location.port;var fullscreen=false;var maxviews=4;var prw,prh;var presstage,preslayer;var evbutspacewidth=150;var views=[];var layers=[];var viewnonselcol="#ddddee";var viewselectcol="#ccddee";var viewwidth=150;var viewgap=30;var viewheight=300;var viewtextspace=15;var viewXoffset=50;var viewYoffset=30;var presenteventoffset=25;var presenteventgap=5;var prmargin=5;var prstagew=evbutspacewidth+viewXoffset+maxviews*viewwidth+(maxviews-1)*viewgap+2*prmargin;var prstageh=viewYoffset+viewheight+viewtextspace+prmargin;var presentevents=[];var peevobjh=30;var peevobjw=maxviews*viewwidth+(maxviews-1)*viewgap;var peevnonselcol="#ccdddd";var peevselectcol="#ffffaa";var activepeevobj=null;var activeviewobj=null;var actobjw=100;var actobjh=15;var actobjgap=2;var designready=false;var mousedown_action=false;var openingProject=false;var playmode=false;var sspeevnonselcol="#ccddcc";var sspeevselectcol="#aaaaff";function updateViewState(f){var e=Object.keys(f)[0];var b=f[e];var c=activeviewobj.getAttr("state");c[e]=b;if(e=="name"){activeviewobj.find(".viewname")[0].text(b)}var d=views.indexOf(activeviewobj);if(d>-1){for(var a=0;a<presentevents.length;a++){pestate=presentevents[a].getAttr("state");(pestate.peviews[d]).viewstate.name=b}}txPEventsArr();preslayer.draw()}function updateViewPropDisp(){var e=activeviewobj.getAttr("state");$("#proptable").empty();for(var c in e){if(c!="peviews"&&c!="id"){var b=e[c];if(c=="type"){$("#proptable").append('<tr><td class="tablekey">'+c+'</td><td class="tableval" style="text-align:left">'+b+"</td></tr>")}else{if(isNaN(b)){$("#proptable").append('<tr><td class="tablekey">'+c+'</td><td class="tableval"><input id="prop'+c+'" type="text" style="text-align:left" size="10" onchange="updateViewState({'+c+':this.value})"></td></tr>')}else{$("#proptable").append('<tr><td class="tablekey">'+c+'</td><td class="tableval"><input id="prop'+c+'" type="text" style="text-align:right" size="10" onchange="updateViewState({'+c+':checkInput(this.value)})"></td></tr>')}var d=document.getElementById("prop"+c);if(isNaN(b)){$("#prop"+c).val(b)}else{var a=parseFloat(b);if((a%1)==0){$("#prop"+c).val(b.toFixed(0))}else{$("#prop"+c).val(b.toFixed(2))}}}}}}function updatePElayer(d,a){var c=activepeevobj.getAttr("state");var b=c.peviews[d];b.layerid=layers[a].layerid;b.layername=layers[a].layername}function updatePEState(f){var e=Object.keys(f)[0];var b=f[e];var c=activepeevobj.getAttr("state");if(e=="name"&&b!="startevent"){activepeevobj.find(".peevname")[0].text(b);c[e]=b}else{if(e.slice(0,7)=="peviews"){var d=parseInt(e.slice(7));var a=parseInt(b);updatePElayer(d,a)}}txPEventsArr();preslayer.draw()}function updatePEpropDisp(){if(activepeevobj!=null){var b=activepeevobj.getAttr("state");$("#proptable").empty();for(var j in b){if(j!="actiontype"&&j!="index"&&j!="id"){var l=b[j];if(j=="name"&&l=="startevent"){$("#proptable").append('<tr><td class="tablekey">'+j+'</td><td class="tableval" style="text-align:left">'+l+"</td></tr>")}else{if(j=="peviews"){var a="";for(var k=0;k<layers.length;k++){var f=layers[k].layername;a=a+'<option value="'+f+'">'+f+"</option>"}var d=l;$("#proptable").append('<tr><td class="tablekey">View</td><td class="tableval" style="text-align:left">Layer</td></tr>');for(var g=0;g<views.length;g++){var i=views[g].getAttr("state").name;var e=d[g];$("#proptable").append('<tr><td class="tablekey">'+i+'</td><td class="tableval"><select id="prop'+j+g.toFixed(0)+'" class="layerselect" size="1" onchange="updatePEState({'+j+g.toFixed(0)+':this.selectedIndex})"></select></td></tr>');$("#prop"+j+g.toFixed(0)).empty();$("#prop"+j+g.toFixed(0)).append(a);$("#prop"+j+g.toFixed(0)).val(e.layername)}}else{if(isNaN(l)){$("#proptable").append('<tr><td class="tablekey">'+j+'</td><td class="tableval"><input id="prop'+j+'" type="text" style="text-align:left" size="10" onchange="updatePEState({'+j+':this.value})"></td></tr>')}else{$("#proptable").append('<tr><td class="tablekey">'+j+'</td><td class="tableval"><input id="prop'+j+'" type="text" style="text-align:right" size="10" onchange="updatePEState({'+j+':checkInput(this.value)})"></td></tr>')}var c=document.getElementById("prop"+j);if(isNaN(l)){$("#prop"+j).val(l)}else{var h=parseFloat(l);if((h%1)==0){$("#prop"+j).val(l.toFixed(0))}else{$("#prop"+j).val(l.toFixed(2))}}}}}}}}function clearProps(){$("#proptable").empty()}function enableDesignButtons(){if(presentevents.length>0){$("#deletepebutton").prop("disabled",false)}else{$("#deletepebutton").prop("disabled",true)}$("#createpebutton").prop("disabled",false);$("#txscrbutton").prop("disabled",false)}function disableDesignButtons(){$("#deletepebutton").prop("disabled",true);$("#txscrbutton").prop("disabled",false);$("#createpebutton").prop("disabled",true)}function updateallPEventActions(e){for(var c=0;c<e.length;c++){var b=e[c];var d=preslayer.find("#"+b.id)[0];var a=d.getAttr("state");a.peviews=b.peviews;updatePresentEvent(d)}}function delPresentEvent(){if(activepeevobj!=null){var a=confirm("Are you sure you want to delete this event?");if(a==true){var c=presentevents.indexOf(activepeevobj);if(c>-1){presentevents.splice(c,1);activepeevobj.destroyChildren();activepeevobj.destroy();for(var b=0;b<presentevents.length;b++){var d=presentevents[b].getAttr("state");d.index=b}updateViews();txPEventsDelete(c);if(presentevents.length>0){$("#deletepebutton").prop("disabled",false)}else{$("#deletepebutton").prop("disabled",true)}}}}}function updatePresentEvent(d){var c=d.getAttr("state");var p=d.find(".actionname").toArray();for(var k=0;k<p.length;k++){p[k].destroy()}var m=c.peviews;var n=0;for(var l=0;l<m.length;l++){var h=m[l].actions;var q=h.length;if(q>n){n=q}for(var o=0;o<h.length;o++){var b=h[o];var g=new Kinetic.Text({name:"actionname",draggable:false,x:(l*(viewwidth+viewgap))+viewXoffset+evbutspacewidth+3,y:3+o*(actobjh+actobjgap),text:b.name,fontSize:12,fill:"black"});d.add(g);g.moveToTop()}}if(n*(actobjh+actobjgap)<peevobjh){d.find(".peevblock")[0].height(peevobjh)}else{d.find(".peevblock")[0].height(n*(actobjh+actobjgap))}var a=viewYoffset+presenteventoffset+peevobjh+presenteventgap;for(var k=0;k<c.index;k++){var e=presentevents[k];var f=e.find(".peevblock")[0];a=a+f.height()+presenteventgap}d.y(a);preslayer.draw()}function newPresentEvent(){var f=presentevents.length;var a=[];var e={name:"event",index:f,id:UniqueId(),actiontype:"Eventlist"};for(var d=0;d<views.length;d++){var b={id:UniqueId(),parentid:e.id,viewstate:views[d].getAttr("state"),layerid:"none",layername:"none",actions:[]};a.push(b)}e.peviews=a;var c=makePresentEvent(e);return c}function makePresentEvent(e){var b=new Kinetic.Group({name:"presentevent",draggable:true,id:e.id,x:prmargin,y:viewYoffset,width:peevobjw+evbutspacewidth+viewXoffset,height:peevobjh});b.setAttr("state",e);var f=new Kinetic.Rect({name:"peevblock",draggable:false,x:0,y:0,width:peevobjw+evbutspacewidth+viewXoffset,height:peevobjh,cornerRadius:0,fill:peevnonselcol,stroke:"black",strokeWidth:1});var a=new Kinetic.Text({name:"peevname",draggable:false,x:5,y:5,text:e.name,fontSize:12,fill:"black"});var d=new Kinetic.RegularPolygon({x:150,y:15,draggable:false,sides:3,radius:10,rotation:-90,fill:"#000"});var c=new Kinetic.RegularPolygon({x:170,y:15,draggable:false,sides:3,radius:10,rotation:90,fill:"#000"});b.add(f);b.add(a);b.add(d);b.add(c);d.moveToTop();c.moveToTop();preslayer.add(b);d.on("mouseover",function(){document.body.style.cursor="pointer";cursorstate="onpeev"});d.on("mouseout",function(){document.body.style.cursor="default";cursorstate="free"});d.on("mousedown",function(){mousedown_action=true;if(activepeevobj==this.getParent()){txstartEvent(activepeevobj)}});c.on("mouseover",function(){document.body.style.cursor="pointer";cursorstate="onpeev"});c.on("mouseout",function(){document.body.style.cursor="default";cursorstate="free"});c.on("mousedown",function(){mousedown_action=true;if(activepeevobj==this.getParent()){txplayEvent(activepeevobj)}});b.on("mousedown",function(){if(mousedown_action==false){activepeevobj=this;var j=preslayer.getChildren().toArray();for(var h=0;h<j.length;h++){var g=j[h];if(activepeevobj==g){g.find(".peevblock").fill(peevselectcol)}else{g.find(".peevblock").fill(peevnonselcol)}}preslayer.draw();castPresentEvent();if(playmode==true){setTimeout(function(){txplayEvent(activepeevobj)},200)}}else{mousedown_action=false}updatePEpropDisp()});b.on("dragend",function(l){var n=this.y();var g=0;var k=(this.getAttr("state")).index;var j=presentevents.length;while((g<j)&&(n>=presentevents[g].y())){g=g+1}presentevents.splice(k,1);if(g<k){presentevents.splice(g,0,b)}else{presentevents.splice(g-1,0,b)}for(var h=0;h<j;h++){var m=presentevents[h].getAttr("state");m.index=h}this.x(prmargin);txPEventsArr();updatePresentEvent(this);updateViews()});presentevents.push(b);if(openingProject==false){txPEventsArr()}updatePresentEvent(b);updateViews();if(presentevents.length>0){$("#deletepebutton").prop("disabled",false)}else{$("#deletepebutton").prop("disabled",true)}return b}function makeStartEvent(g){var c=0;var j={name:"startevent",index:c,id:UniqueId(),actiontype:"Eventlist"};if(g==null){var b=[];for(var e=0;e<views.length;e++){var d={id:UniqueId(),parentid:j.id,viewstate:views[e].getAttr("state"),layerid:"none",layername:"none",actions:[]};b.push(d)}j.peviews=b}else{j.peviews=g}var f=new Kinetic.Group({name:"startevent",draggable:false,id:j.id,x:prmargin,y:viewYoffset,width:peevobjw+evbutspacewidth+viewXoffset,height:peevobjh});f.setAttr("state",j);var h=new Kinetic.Rect({name:"peevblock",draggable:false,x:0,y:0,width:peevobjw+evbutspacewidth+viewXoffset,height:peevobjh,cornerRadius:0,fill:sspeevnonselcol,stroke:"black",strokeWidth:1});var k=new Kinetic.Text({name:"peevname",draggable:false,x:5,y:5,text:j.name,fontSize:12,fill:"black"});f.add(h);f.add(k);preslayer.add(f);f.on("mousedown",function(){if(mousedown_action==false){activepeevobj=this;var n=preslayer.getChildren().toArray();for(var m=0;m<n.length;m++){var l=n[m];if(activepeevobj==l){l.find(".peevblock").fill(sspeevselectcol)}else{l.find(".peevblock").fill(sspeevnonselcol)}}preslayer.draw();castStartEvent()}else{mousedown_action=false}updatePEpropDisp()});var a=viewYoffset+presenteventoffset;f.y(a);preslayer.draw();return f}function newView(){if(views.length<maxviews){var h={name:"view"};var p=new Array();for(var c=0;c<views.length;c++){var g=views[c];var m=g.getAttr("state").name;p.push(m)}var n=p.indexOf(h.name+"0");if(n==-1){d=h.name+"0"}else{var o=0;var k=true;while(o<1000&&k){var d=h.name+o.toString();if(p.indexOf(d)==-1){k=false}else{o=o+1}}}h.name=d;var j=makeView(h);views.push(j);var f=preslayer.find(".startevent")[0];if(f!=null){var a=f.getAttr("state");a.peviews.push({viewstate:h,layerid:"none",layername:"none"})}for(var e=0;e<presentevents.length;e++){var l=presentevents[e].getAttr("state");l.peviews.push({id:UniqueId(),viewstate:h,layerid:"none",layername:"none",actions:[]})}txPEventsArr();for(var b=0;b<views.length;b++){views[c].moveToBottom()}if(views.length>0){$("#deleteviewbutton").prop("disabled",false)}else{$("#deleteviewbutton").prop("disabled",true)}if(views.length<maxviews){$("#createviewbutton").prop("disabled",false)}else{$("#createviewbutton").prop("disabled",true)}}}function delView(){if(activeviewobj!=null){var b=confirm("Are you sure you want to delete this view?");if(b==true){var d=views.indexOf(activeviewobj);if(d>-1){views.splice(d,1);activeviewobj.destroyChildren();activeviewobj.destroy();if(views.length>0){$("#deleteviewbutton").prop("disabled",false)}else{$("#deleteviewbutton").prop("disabled",true)}if(views.length<maxviews){$("#createviewbutton").prop("disabled",false)}else{$("#createviewbutton").prop("disabled",true)}var c=preslayer.find(".startevent")[0];var f=c.getAttr("state");f.peviews.splice(d,1);for(var a=0;a<presentevents.length;a++){var e=presentevents[a].getAttr("state");e.peviews.splice(d,1)}txPEventsArr()}updateViews();preslayer.draw()}}}function updateViews(){var c=presenteventoffset;for(var a=0;a<presentevents.length;a++){var e=presentevents[a];c=c+e.find(".peevblock")[0].height()+presenteventgap}if(c<viewheight){c=viewheight}for(var b=0;b<views.length;b++){var d=views[b];d.x((b*(viewwidth+viewgap))+viewXoffset+evbutspacewidth);d.find(".viewblock").height(c)}prstageh=viewYoffset+c+viewtextspace+prmargin;presstage.height(prstageh)}function makeView(d){var e=views.length;var c=new Kinetic.Group({name:"view",draggable:false,x:(e*(viewwidth+viewgap))+viewXoffset+evbutspacewidth,y:viewYoffset,width:viewwidth,height:viewheight+viewtextspace});var b=new Kinetic.Rect({name:"viewblock",draggable:false,x:0,y:viewtextspace,width:viewwidth,height:viewheight,cornerRadius:5,fill:viewnonselcol,stroke:"black",strokeWidth:1});var a=new Kinetic.Text({name:"viewname",draggable:false,x:0,y:0,text:d.name,fontSize:12,fill:"black"});c.add(b);c.add(a);preslayer.add(c);c.moveToBottom();a.moveToTop();preslayer.draw();c.on("mousedown",function(){if(mousedown_action==false){activeviewobj=this;var g=preslayer.getChildren().toArray();for(var h=0;h<g.length;h++){var f=g[h];if(activeviewobj==f){f.find(".viewblock").fill(viewselectcol)}else{f.find(".viewblock").fill(viewnonselcol)}}preslayer.draw()}else{mousedown_action=false}updateViewPropDisp()});c.setAttr("state",d);return c}function createPEandViews(h){var d=h.evl;var e=h.sev;preslayer.destroyChildren();presstage.clear();makeStartEvent(e);if(d.length>0){var c=d[0];var g=c.peviews;for(var f=0;f<g.length;f++){var b=makeView(g[f].viewstate);views.push(b)}for(var a=0;a<d.length;a++){c=d[a];makePresentEvent(c)}preslayer.draw();openingProject=false}}function togFullscreen(){var a=document.documentElement;if(fullscreen==false){if(a.RequestFullScreen){a.RequestFullScreen();fullscreen=true}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen();fullscreen=true}else{if(a.webkitRequestFullScreen){a.webkitRequestFullScreen();fullscreen=true}}}}else{if(document.cancelFullScreen){document.cancelFullScreen();fullscreen=false}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen();fullscreen=false}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();fullscreen=false}}}}}function setCastmode(){castmode=$("#castaction").prop("checked")}function screenSetup(){var c=$(window).width();var a=$(window).height();$("#page").css({height:Math.round(0.98*a).toString()+"px"});$("#page").css({width:Math.round(0.98*c).toString()+"px"});var d=$("#page").height();var b=$("#page").width();$("#leftcolumn").css({height:Math.round(1*d).toString()+"px"});$("#leftcolumn").css({width:Math.round(0.2*b).toString()+"px"});$("#rightcolumn").css({left:Math.round(0.2*b).toString()+"px"});$("#rightcolumn").css({height:Math.round(1*d).toString()+"px"});$("#rightcolumn").css({width:Math.round(0.8*b).toString()+"px"});$("#functionspace").css({height:Math.round(0.5*d).toString()+"px"});$("#presentspace").css({height:Math.round(d-10).toString()+"px"});$("#propedit").css({height:Math.round(0.5*d-12).toString()+"px"});prh=$("#presentspace").height();prw=$("#presentspace").width()}function resizeStages(){}function castPresentEvent(){if(activepeevobj!=null){var a=presentevents.indexOf(activepeevobj);if(a>-1){var b=JSON.stringify({command:"castPEinfo",info:a});socket.emit("updateEvents",b)}}}function castStartEvent(){if(activepeevobj!=null){var a=preslayer.find(".startevent")[0];var b=a.getAttr("state");var c=b.peviews;var d=JSON.stringify({command:"castStartinfo",info:c});socket.emit("updateEvents",d)}}function txPEventsArr(){var g=[];for(var c=0;c<presentevents.length;c++){var b=presentevents[c].getAttr("state");g.push(b)}var a=preslayer.find(".startevent")[0];var e=a.getAttr("state");var d=e.peviews;var f=JSON.stringify({command:"updateEventArr",info:{pel:g,sev:d}});socket.emit("updateEvents",f)}function txPEventsDelete(a){var b=JSON.stringify({command:"deleteEventList",info:a});socket.emit("updateEvents",b)}function txPEventsCheckDesign(){var a=JSON.stringify({command:"checkDesignScreen",info:""});socket.emit("updateEvents",a)}function txPEventsGetLayerInfo(){var a=JSON.stringify({command:"getLayerinfo",info:""});socket.emit("updateEvents",a)}function txPEventsGetPEInfo(){var a=JSON.stringify({command:"getPEinfo",info:""});socket.emit("updateEvents",a)}function txplayPEEvents(a){var b=JSON.stringify({command:"playPE",info:a});socket.emit("updateEvents",b)}function txstartPEEvents(a){var b=JSON.stringify({command:"startPE",info:a});socket.emit("updateEvents",b)}function txplayEvent(f){var c=presentevents.indexOf(f);txplayPEEvents(c);var b=f.getAttr("state");for(var g=0;g<b.peviews.length;g++){var e=b.peviews[g];var i=e.viewstate.name;var d=e.layerid;if(d!="none"&&e.actions.length>0){var a={view:i,scrtxmsg:{command:"play",info:""}};var h=JSON.stringify(a);socket.emit("screenmsg",h)}}}function txstartEvent(f){var c=presentevents.indexOf(f);txstartPEEvents(c);var b=f.getAttr("state");for(var g=0;g<b.peviews.length;g++){var e=b.peviews[g];var i=e.viewstate.name;var d=e.layerid;if(d!="none"&&e.actions.length>0){var a={view:i,scrtxmsg:{command:"start",info:""}};var h=JSON.stringify(a);socket.emit("screenmsg",h)}}}function ioUpdate(b){var f=JSON.parse(b);var e=f.command;switch(e){case"designready":var d=f.info;if(d=="openready"){designready=true;$("#createpebutton").prop("disabled",false);$("#createviewbutton").prop("disabled",false);txPEventsGetPEInfo()}else{if(d=="newready"){designready=true;$("#createpebutton").prop("disabled",false);$("#createviewbutton").prop("disabled",false);makeStartEvent([]);txPEventsGetLayerInfo()}else{designready=false;alert("Designscreen is not ready")}}break;case"layerinfo":layers=[{layerid:"none",layername:"none"}];Array.prototype.push.apply(layers,f.info);updatePEpropDisp();break;case"peinfo":var c=f.info;openingProject=true;createPEandViews(c);txPEventsGetLayerInfo();break;case"updateAllPEventActions":var a=f.info;updateallPEventActions(a);break}}function setPlaymode(){playmode=$("#playaction").prop("checked")}function setup(){if(USEIO){socket=io(serverurl);socket.on("designmsg",function(a){ioUpdate(a)})}presstage=new Kinetic.Stage({container:presentspace,name:"presentscreen",width:prstagew,height:prstageh});preslayer=new Kinetic.Layer({name:"preslayer"});presstage.add(preslayer);preslayer.draw();txPEventsCheckDesign();disableDesignButtons();document.addEventListener("fullscreenchange",function(){screenSetup();resizeStages()},false);document.addEventListener("mozfullscreenchange",function(){screenSetup();resizeStages()},false);document.addEventListener("webkitfullscreenchange",function(){screenSetup();resizeStages()},false);screenSetup();$("#playaction").prop("checked",playmode);$("#functionspace").resizable({handles:"s",minHeight:200,maxHeight:380,resize:function(a,c){var e=c.size.height;var d=12;$(this).height(e);var b=$("#leftcolumn").height();$("#propedit").height(b-e-d)}})};